var emodule=function(t){"use strict";function s(t){var s=Object.create(null);return t&&Object.keys(t).forEach(function(i){if("default"!==i){var e=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(s,i,e.get?e:{enumerable:!0,get:function(){return t[i]}})}}),s.default=t,Object.freeze(s)}var i=s(t);class e extends i.control.AbstractControl{get filename(){return"/code.js"}constructor(){super(...arguments),this.emits={init:null},this.props={init:{sid:"",skey:""},controls:!0,layout:[{cellNum:4,rows:2,columns:2,cellList:[[0,0],[1,1],[2,2],[3,3]]}],list:[],range:null,volume:10},this.access={tplink:void 0,instance:void 0},this.notInit=!1,this.isLoading=!0,this.initCount=0,this.rand="",this.indexs=[]}_init(){this.access.instance=new this.access.tplink({szPluginContainer:"cg-control-tplink-"+this.rand,iServicePortStart:15410,iServicePortEnd:15419,cbConnectSuccess:async()=>{const t=this.refs.content.getBoundingClientRect();try{await this.access.instance.CreateWnd("cg-control-tplink-"+this.rand,Math.round(t.width),Math.round(t.height),0),this.initCount=0,this.access.instance.InitAuthInfo(this.props.init.sid,this.props.init.skey),this.access.instance.SetCustomLayout(JSON.stringify(this.props.layout)),this.propBoolean("controls")||this.access.instance.HideWndToolbar(),this._play()}catch(t){console.log("[CONTROL] [TPLINK] ERROR",t)}},cbConnectError:async()=>{this.access.instance=null,this.access.tplink.WakeUpPlugin("SMBCloudHDPlugin://"),++this.initCount,this.initCount>3&&i.form.alert("Tplink error","danger"),i.form.alert("Tplink retry "+this.initCount,"warning"),await i.tool.sleep(3e3),this._init()},cbConnectClose:async()=>{this.access.instance=null,this.access.tplink.WakeUpPlugin("SMBCloudHDPlugin://"),++this.initCount,this.initCount>3&&i.form.alert("Tplink error","danger"),i.form.alert("Tplink retry "+this.initCount,"warning"),await i.tool.sleep(3e3),this._init()}})}_clear(){for(const t of this.indexs)t.range?this.access.instance.StopPlayback(t.index):this.access.instance.StopPreview(t.index);this.indexs.length=0}_play(){for(const t of this.props.list){let s="",e="";t.device.includes("-")||t.device.includes(":")?e=t.device.replace(/:/g,"-"):s=t.device,null===this.props.range?(this.access.instance.StartPreview(s,e,t.channel,t.index,t.mode),this.indexs.push({index:t.index,range:!1,volume:t.volume??!0})):(this.access.instance.StartPlayback(s,e,t.channel,t.index,i.tool.isMs(this.props.range[0])?this.props.range[0]:1e3*this.props.range[0]),this.indexs.push({index:t.index,range:!0,volume:t.volume??!0})),this.access.instance.SetVolume(t.index,!1===t.volume?0:this.propInt("volume"))}}refresh(){this.access.instance&&(this._clear(),this._play())}startTalk(t){this.access.instance&&this.access.instance.StartTalk(t)}stopTalk(t){this.access.instance&&this.access.instance.StopTalk(t)}async onMounted(){this.rand=i.tool.random(16);const t=await i.core.getModule("tplinkhd");if(!t)return this.isLoading=!1,void(this.notInit=!0);this.access.tplink=t,this._init();let s=0;i.dom.watchPosition(this.element,async()=>{if(!this.access.instance)return;const t=++s,e=this.refs.content.getBoundingClientRect();this.access.instance.Resize(Math.round(e.width),Math.round(e.height)),await i.tool.sleep(600),t<s||this.access.instance.Resize(Math.round(e.width),Math.round(e.height))}),this.watch("layout",()=>{this.access.instance&&this.access.instance.SetCustomLayout(JSON.stringify(this.props.layout))},{deep:!0}),this.watch("controls",()=>{this.access.instance&&(this.propBoolean("controls")?this.access.instance.ShowWndToolbar():this.access.instance.HideWndToolbar())}),this.watch("list",()=>{this.refresh()},{deep:!0}),this.watch("range",()=>{this.refresh()},{deep:!0}),this.watch("volume",()=>{for(const t of this.indexs)this.access.instance.SetVolume(t.index,t.volume?this.propInt("volume"):0)}),this.isLoading=!1,this.emit("init",{tplink:this.access.tplink,instance:this.access.instance})}onUnmounted(){this.access.instance&&this.access.instance.DestroyWnd()}}return e}(clickgo.modules.clickgo);